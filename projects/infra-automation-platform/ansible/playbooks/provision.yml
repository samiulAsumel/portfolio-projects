---
- name: Provision and configure infrastructure servers
  hosts: all
  gather_facts: true
  become: true

  pre_tasks:
    - name: Update package cache (RHEL/CentOS/Fedora/Rocky)
      ansible.builtin.yum:
        update_cache: true
      when: ansible_os_family == "RedHat"
      tags: always

    - name: Update package cache (Debian/Ubuntu)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: "{{ package_update_cache_valid_time }}"
      when: ansible_os_family == "Debian"
      tags: always

    - name: Update package cache (openSUSE)
      community.general.zypper:
        name: ""
        state: present
      when: ansible_os_family == "Suse"
      tags: always

    - name: Update package cache (Arch Linux)
      ansible.builtin.dnf:
        update_cache: true
      when: ansible_os_family == "Arch"
      tags: always

  roles:
    - role: common
      tags: common

    - role: ssh-keys
      tags: ssh-keys

    - role: security
      tags: security

    - role: monitoring
      tags: monitoring
