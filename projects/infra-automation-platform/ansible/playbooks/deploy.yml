---
- name: Deploy application to web servers
  hosts: web_servers
  gather_facts: true
  become: true
  serial: "{{ deployment_serial | default(1) }}"

  vars:
    deployment_artifact: /tmp/application.tar.gz
    deployment_version: "{{ app_version | default('latest') }}"

  pre_tasks:
    - name: Verify deployment artifact exists
      stat:
        path: "{{ deployment_artifact }}"
      register: artifact_stat
      delegate_to: localhost
      run_once: true
      become: false

    - name: Fail if artifact missing
      fail:
        msg: "Deployment artifact not found at {{ deployment_artifact }}"
      when: not artifact_stat.stat.exists
      run_once: true

  tasks:
    - name: Create deployment directory
      file:
        path: "{{ app_base_dir }}/releases/{{ deployment_version }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0755"

    - name: Upload application artifact
      copy:
        src: "{{ deployment_artifact }}"
        dest: "{{ app_base_dir }}/releases/{{ deployment_version }}/application.tar.gz"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0644"

    - name: Extract application artifact
      unarchive:
        src: "{{ app_base_dir }}/releases/{{ deployment_version }}/application.tar.gz"
        dest: "{{ app_base_dir }}/releases/{{ deployment_version }}"
        remote_src: true
        owner: "{{ app_user }}"
        group: "{{ app_group }}"

    - name: Install application dependencies
      pip:
        requirements: "{{ app_base_dir }}/releases/{{ deployment_version }}/requirements.txt"
        virtualenv: "{{ app_base_dir }}/releases/{{ deployment_version }}/venv"
        virtualenv_python: python3
      become_user: "{{ app_user }}"
      when: app_type == "python"

    - name: Stop application service
      systemd:
        name: application
        state: stopped

    - name: Update current symlink
      file:
        src: "{{ app_base_dir }}/releases/{{ deployment_version }}"
        dest: "{{ app_base_dir }}/current"
        state: link
        force: true

    - name: Start application service
      systemd:
        name: application
        state: started
        daemon_reload: true

    - name: Verify application health
      uri:
        url: "http://localhost:{{ web_server_port }}/health"
        status_code: 200
        timeout: 10
        retries: 5
        delay: 5
      register: health_check

    - name: Cleanup old releases
      shell: |
        cd {{ app_base_dir }}/releases
        ls -t | tail -n +6 | xargs -r rm -rf
      args:
        executable: /bin/bash
      when: cleanup_old_release | default(true) | bool

  post_tasks:
    - name: Log deployment
      lineinfile:
        path: "{{ app_base_dir }}/deployments.log"
        line: "{{ ansible_date_time.iso8601_date }} - {{ deployment_version }} deployed"
        create: true
        mode: "0644"
      register: deployment_log
